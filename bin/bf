#!/bin/bash
#
# BrowserFlow CLI
# Human-in-the-Loop E2E Test Generation
#

set -euo pipefail

BROWSERFLOW_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
VERSION="0.1.0-dev"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
BOLD='\033[1m'
NC='\033[0m'

show_help() {
    cat << EOF
${BOLD}BrowserFlow${NC} - Human-in-the-Loop E2E Test Generation

${BOLD}USAGE${NC}
    bf <command> [options]

${BOLD}COMMANDS${NC}
    ${GREEN}init${NC}              Initialize BrowserFlow in current project
    ${GREEN}setup${NC}             Install dependencies and configure environment
    
    ${GREEN}explore${NC}           Run AI exploration for a spec
        --spec <name>     Spec name (required)
        --url <url>       Base URL (default: from config)
        --adapter <name>  LLM adapter (default: claude)
    
    ${GREEN}review${NC}            Manage exploration reviews
        serve             Start review server
        approve           Approve exploration
        reject            Reject exploration with reason
        status            Show review status
    
    ${GREEN}codify${NC}            Generate test from approved exploration
        --spec <name>     Spec name (required)
    
    ${GREEN}run${NC}               Execute codified tests
        [spec]            Run specific spec (or all if omitted)
        --tag <tag>       Filter by tag
        --parallel <n>    Parallel execution count
    
    ${GREEN}baseline${NC}          Manage screenshot baselines
        update            Update baselines from latest exploration
        diff              Show baseline differences
    
    ${GREEN}ci${NC}                Run in CI mode (non-interactive)
        --all             Run all tests
        --spec <name>     Run specific spec

${BOLD}OPTIONS${NC}
    -h, --help        Show this help
    -v, --version     Show version
    --verbose         Enable verbose output
    -C, --workdir     Set working directory

${BOLD}EXAMPLES${NC}
    # Initialize in a new project
    bf init
    
    # Explore a spec
    bf explore --spec checkout-flow --url http://localhost:3000
    
    # Review and approve
    bf review serve --spec checkout-flow
    # Then in browser: review and click approve
    # Or via CLI: bf review approve --spec checkout-flow
    
    # Generate test
    bf codify --spec checkout-flow
    
    # Run in CI
    bf ci --all

${BOLD}DOCUMENTATION${NC}
    https://github.com/your-org/browserflow

EOF
}

show_version() {
    echo "browserflow $VERSION"
}

cmd_init() {
    echo -e "${BLUE}Initializing BrowserFlow...${NC}"
    
    # Create directory structure
    mkdir -p specs explorations reviews generated baselines
    
    # Create default config
    if [[ ! -f browserflow.yaml ]]; then
        cat > browserflow.yaml << 'YAML'
# BrowserFlow Configuration
project:
  name: my-project
  base_url: http://localhost:3000

browser:
  engine: chromium
  headless: true
  viewport:
    width: 1280
    height: 720

exploration:
  adapter: claude
  max_retries: 3

review:
  port: 8190
YAML
        echo -e "${GREEN}Created browserflow.yaml${NC}"
    fi
    
    # Create example spec
    if [[ ! -f specs/example.yaml ]]; then
        cat > specs/example.yaml << 'YAML'
name: example
description: Example spec - customize for your app

steps:
  - action: navigate
    to: "/"
    
  - action: screenshot
    name: "homepage"
    
  - action: verify_state
    checks:
      - element_visible: "body"

tags:
  - example
YAML
        echo -e "${GREEN}Created specs/example.yaml${NC}"
    fi
    
    echo -e "${GREEN}BrowserFlow initialized!${NC}"
    echo ""
    echo "Next steps:"
    echo "  1. Edit browserflow.yaml with your project settings"
    echo "  2. Write specs in specs/ directory"
    echo "  3. Run: bf explore --spec <name>"
}

cmd_setup() {
    echo -e "${BLUE}Setting up BrowserFlow dependencies...${NC}"
    
    # Check for required tools
    local missing=()
    
    command -v jq &>/dev/null || missing+=("jq")
    command -v curl &>/dev/null || missing+=("curl")
    
    # Check for agent-browser
    if ! command -v agent-browser &>/dev/null; then
        echo -e "${YELLOW}agent-browser not found. Installing...${NC}"
        # Installation command depends on system
        echo "Please install agent-browser manually:"
        echo "  npm install -g @anthropic-ai/agent-browser"
        echo "  # or"
        echo "  bun install -g @anthropic-ai/agent-browser"
    fi
    
    if [[ ${#missing[@]} -gt 0 ]]; then
        echo -e "${RED}Missing required tools: ${missing[*]}${NC}"
        echo "Please install them and run setup again."
        exit 1
    fi
    
    echo -e "${GREEN}Setup complete!${NC}"
}

cmd_explore() {
    echo -e "${YELLOW}Exploration not yet implemented${NC}"
    echo "This will spawn an AI agent to explore the UI based on your spec."
    echo ""
    echo "Coming soon!"
}

cmd_review() {
    local subcmd="${1:-}"
    shift || true
    
    case "$subcmd" in
        serve)
            echo -e "${BLUE}Starting review server...${NC}"
            echo -e "${YELLOW}Review UI not yet implemented${NC}"
            echo "This will serve an interactive review interface."
            ;;
        approve|reject|status)
            echo -e "${YELLOW}Review $subcmd not yet implemented${NC}"
            ;;
        *)
            echo "Usage: bf review <serve|approve|reject|status> [options]"
            exit 1
            ;;
    esac
}

cmd_codify() {
    echo -e "${YELLOW}Codification not yet implemented${NC}"
    echo "This will generate a deterministic bash test from approved exploration."
}

cmd_run() {
    echo -e "${YELLOW}Test runner not yet implemented${NC}"
    echo "This will execute codified tests."
}

cmd_ci() {
    echo -e "${YELLOW}CI mode not yet implemented${NC}"
    echo "This will run tests in non-interactive CI mode."
}

# Main dispatch
main() {
    local cmd="${1:-}"
    shift || true
    
    case "$cmd" in
        init)
            cmd_init "$@"
            ;;
        setup)
            cmd_setup "$@"
            ;;
        explore)
            cmd_explore "$@"
            ;;
        review)
            cmd_review "$@"
            ;;
        codify)
            cmd_codify "$@"
            ;;
        run)
            cmd_run "$@"
            ;;
        ci)
            cmd_ci "$@"
            ;;
        -h|--help|help)
            show_help
            ;;
        -v|--version|version)
            show_version
            ;;
        "")
            show_help
            ;;
        *)
            echo -e "${RED}Unknown command: $cmd${NC}"
            echo "Run 'bf --help' for usage."
            exit 1
            ;;
    esac
}

main "$@"
